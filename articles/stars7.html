<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>7. Statistical modelling with stars objects • stars</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="7. Statistical modelling with stars objects">
<meta property="og:description" content="stars">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">stars</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.5-4</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/stars1.html">1. introduction</a>
    </li>
    <li>
      <a href="../articles/stars2.html">2. stars proxy objects</a>
    </li>
    <li>
      <a href="../articles/stars3.html">3. stars tidyverse methods</a>
    </li>
    <li>
      <a href="../articles/stars4.html">4. stars data model</a>
    </li>
    <li>
      <a href="../articles/stars5.html">5. vector-raster conversions, reprojection, warping</a>
    </li>
    <li>
      <a href="../articles/stars6.html">6. How `raster` functions map to `stars` functions</a>
    </li>
    <li>
      <a href="../articles/stars7.html">7. Statistical modelling with stars objects</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/r-spatial/stars/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="stars7_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>7. Statistical modelling with stars objects</h1>
                        <h4 class="author">Edzer Pebesma</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-spatial/stars/blob/master/vignettes/stars7.Rmd"><code>vignettes/stars7.Rmd</code></a></small>
      <div class="hidden name"><code>stars7.Rmd</code></div>

    </div>

    
    
<p>We will first fix the random number seed, to get identical results for procedures that involve random sampling. Remove this command if you want the random effect in outcomes.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">131</span><span class="op">)</span></code></pre></div>
<div id="training-and-prediction-with-stars-objects" class="section level2">
<h2 class="hasAnchor">
<a href="#training-and-prediction-with-stars-objects" class="anchor"></a>Training and prediction with stars objects</h2>
<p>The usual way of statistical modelling in R uses <code>data.frame</code>s (or tibbles), and proceeds like</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m</span> <span class="op">=</span> <span class="fu">model</span><span class="op">(</span><span class="va">formula</span>, <span class="va">data</span><span class="op">)</span>
<span class="va">pr</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">m</span>, <span class="va">newdata</span><span class="op">)</span></code></pre></div>
<p>where <code>model</code> is a function like <code>lm</code>, <code>glm</code>, <code>randomForest</code> etc. that returns a classed object, such that the <code>predict</code> generic can choose the right prediction function based on that class. <code>formula</code> looks like <code>y ~ x1+x2</code> and specifies the dependent variable (<code>y</code>) and predictors (<code>x1</code>, <code>x2</code>), which are found as columns in <code>data</code>. <code>newdata</code> needs to have the predictors in its columns, and returns the predicted values for <code>y</code> at these values for predictors.</p>
<div id="stars-objects-as-data-frames" class="section level3">
<h3 class="hasAnchor">
<a href="#stars-objects-as-data-frames" class="anchor"></a>stars objects as data.frames</h3>
<p>The analogy of stars objects to <code>data.frame</code> is this:</p>
<ul>
<li>each attribute (array) becomes a single column</li>
<li>dimensions become added (index) columns</li>
</ul>
<p>To see how this works with the 6-band example dataset, consider this:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/stars/">stars</a></span><span class="op">)</span>
<span class="co">#&gt; Loading required package: abind</span>
<span class="co">#&gt; Loading required package: sf</span>
<span class="co">#&gt; Linking to GEOS 3.8.0, GDAL 3.0.4, PROJ 6.3.1</span>
<span class="va">l7</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"tif/L7_ETMs.tif"</span>, package <span class="op">=</span> <span class="st">"stars"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">l7</span>
<span class="co">#&gt; stars object with 3 dimensions and 1 attribute</span>
<span class="co">#&gt; attribute(s):</span>
<span class="co">#&gt;              Min. 1st Qu. Median     Mean 3rd Qu. Max.</span>
<span class="co">#&gt; L7_ETMs.tif     1      54     69 68.91242      86  255</span>
<span class="co">#&gt; dimension(s):</span>
<span class="co">#&gt;      from  to  offset delta                       refsys point values x/y</span>
<span class="co">#&gt; x       1 349  288776  28.5 UTM Zone 25, Southern Hem... FALSE   NULL [x]</span>
<span class="co">#&gt; y       1 352 9120761 -28.5 UTM Zone 25, Southern Hem... FALSE   NULL [y]</span>
<span class="co">#&gt; band    1   6      NA    NA                           NA    NA   NULL</span>
<span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">l7</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt;          x       y band L7_ETMs.tif</span>
<span class="co">#&gt; 1 288790.5 9120747    1          69</span>
<span class="co">#&gt; 2 288819.0 9120747    1          69</span>
<span class="co">#&gt; 3 288847.5 9120747    1          63</span>
<span class="co">#&gt; 4 288876.0 9120747    1          60</span>
<span class="co">#&gt; 5 288904.5 9120747    1          61</span>
<span class="co">#&gt; 6 288933.0 9120747    1          61</span></code></pre></div>
<p>We see that we get <strong>one</strong> single variable with the object (array) name, and added columns with the dimension values (x, y, band). In a typical case, we would like to have the six bands distributed over six variables, and have a single observation (row) for each x/y pair. For this, we <em>could</em> use e.g. <code><a href="https://rdrr.io/r/utils/stack.html">utils::unstack</a></code> or <code>dplyr::pivot_wider</code> on this data.frame, but a more efficient way is to use the dedicated <code>split</code> method for <code>stars</code> objects, which resolves a dimension and splits it over attributes, one for each dimension value:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">l7</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/merge.html">split</a></span><span class="op">(</span><span class="st">"band"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt;          x       y X1 X2 X3 X4 X5 X6</span>
<span class="co">#&gt; 1 288790.5 9120747 69 56 46 79 86 46</span>
<span class="co">#&gt; 2 288819.0 9120747 69 57 49 75 88 49</span>
<span class="co">#&gt; 3 288847.5 9120747 63 52 45 66 75 41</span>
<span class="co">#&gt; 4 288876.0 9120747 60 45 35 66 69 38</span>
<span class="co">#&gt; 5 288904.5 9120747 61 52 44 76 92 60</span>
<span class="co">#&gt; 6 288933.0 9120747 61 50 37 78 74 38</span></code></pre></div>
<p>The reason that <code>split</code> is more efficient than the mentioned alternatives is that (i) <code>split</code> does not have to match records based on dimensions (x/y), and (ii) it works for out-of-memory (stars_proxy) arrays, in the chunked process/write loop of <code><a href="../reference/write_stars.html">write_stars()</a></code>. ### Predict for <code>stars</code> objects</p>
<p>The pattern to obtain predictions for all pixels of a <code>stars</code> objects is:</p>
<ul>
<li>use the full dataset or a sample of it to train the model, using <code><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame()</a></code> (possibly after a <code>split</code>)</li>
<li>use <code><a href="https://rdrr.io/r/stats/predict.html">predict(star_object, model)</a></code> to predict for all pixels of <code>stars_object</code>, using the stars-wrapper of the <code>predict</code> method for <code>model</code>.</li>
<li>if there is no <code>predict</code> method for <code>model</code>, provide one (see the <code>kmeans</code> example below)</li>
</ul>
<p>This works both for <code>stars</code> objects (in-memory) as <code>stars_proxy</code> objects (out-of memory). For plotting <code>stars_proxy</code> objects, downsampling is done <em>before</em> prediction (predicting only the pixels that are shown), full rasters can be written to disk with <code><a href="../reference/write_stars.html">write_stars()</a></code>, which will carry out predictions on chunks being read and written.</p>
</div>
</div>
<div id="models-fitted-for-every-pixel" class="section level2">
<h2 class="hasAnchor">
<a href="#models-fitted-for-every-pixel" class="anchor"></a>models fitted for every pixel</h2>
<p>We can run models in many different ways on array data. One way is to run a single model to all pixels, where the model operates e.g. on the spectral (band) or temporal dimension. An example was given <a href="https://r-spatial.github.io/stars/articles/stars2.html#plotting-with-changed-evaluation-order">in vignette 2</a>, where NDVI was computed from the red and near infrared band. NDVI does not involve estimating parameters, but reducing two bands to one.</p>
<p>An example where we fit a model to every pixel would be fit a time series model to each pixel time series, and output one or more model coefficients for each pixel; this is shown next.</p>
<div id="linear-regression-on-pixel-time-series" class="section level3">
<h3 class="hasAnchor">
<a href="#linear-regression-on-pixel-time-series" class="anchor"></a>Linear regression on pixel time series</h3>
<p>We can read in the avhrr dataset, containing only 9 days:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/stars/">stars</a></span><span class="op">)</span>
<span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"avhrr-only-v2.19810901.nc"</span>,
<span class="st">"avhrr-only-v2.19810902.nc"</span>,
<span class="st">"avhrr-only-v2.19810903.nc"</span>,
<span class="st">"avhrr-only-v2.19810904.nc"</span>,
<span class="st">"avhrr-only-v2.19810905.nc"</span>,
<span class="st">"avhrr-only-v2.19810906.nc"</span>,
<span class="st">"avhrr-only-v2.19810907.nc"</span>,
<span class="st">"avhrr-only-v2.19810908.nc"</span>,
<span class="st">"avhrr-only-v2.19810909.nc"</span><span class="op">)</span>
<span class="va">file_list</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"netcdf/"</span>, <span class="va">x</span><span class="op">)</span>, package <span class="op">=</span> <span class="st">"starsdata"</span><span class="op">)</span>
<span class="va">y</span> <span class="op">=</span> <span class="fu"><a href="../reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="va">file_list</span>, sub <span class="op">=</span> <span class="st">"sst"</span>, quiet <span class="op">=</span> <span class="cn">TRUE</span>, proxy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="op">(</span><span class="va">t</span> <span class="op">=</span> <span class="fu"><a href="../reference/st_dimensions.html">st_get_dimension_values</a></span><span class="op">(</span><span class="va">y</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>We will use a function that computes the slope of the regression line for temperature with time. We get temperatures as a vector in the first argument of the function supplied to <code>st_apply</code>, and have <code>t</code> already defined. The function could look like</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">slope</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
    <span class="cn">NA_real_</span>
  <span class="kw">else</span>
    <span class="fu">coeffients</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">x</span><span class="op">~</span><span class="va">t</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>
<span class="op">}</span></code></pre></div>
<p>but we will optimize this a bit, using <code>anyNA</code> and <code>lm.fit</code> rather than <code>lm</code>:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">slope</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">anyNA</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>
    <span class="cn">NA_real_</span>
  <span class="kw">else</span>
    <span class="fu"><a href="https://rdrr.io/r/stats/lmfit.html">lm.fit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">t</span><span class="op">)</span>, <span class="va">x</span><span class="op">)</span><span class="op">$</span><span class="va">coefficients</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>
<span class="op">}</span></code></pre></div>
<p>The result is lazily defined by (<code>adrop</code> drops the singular dimension)</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">out</span> <span class="op">=</span> <span class="fu"><a href="../reference/st_apply.html">st_apply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/abind/man/adrop.html">adrop</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span>, <span class="va">slope</span><span class="op">)</span></code></pre></div>
<p>but only <em>computed</em> by the following command, where the computations are restricted to the pixels plotted:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">out</span>, breaks <span class="op">=</span> <span class="st">"equal"</span>, main <span class="op">=</span> <span class="st">"9-day time trend (slope)"</span><span class="op">)</span></code></pre></div>
<p>An interisting pattern appears (despite the very short time series!): where SST reveals a main signal of colder when getting further from the equator, <em>changes</em> in SST show much more fine grained structures of areas going up, and others going down. A diverging color ramp would be a better choice here, to distinguis positive from negative trends.</p>
</div>
</div>
<div id="unsupervised-learners" class="section level2">
<h2 class="hasAnchor">
<a href="#unsupervised-learners" class="anchor"></a>Unsupervised learners</h2>
<div id="principal-components" class="section level3">
<h3 class="hasAnchor">
<a href="#principal-components" class="anchor"></a>Principal components</h3>
<p>In the first example, we build principal components on the entire data set, because it is rather small.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tif</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"tif/L7_ETMs.tif"</span>, package <span class="op">=</span> <span class="st">"stars"</span><span class="op">)</span>
<span class="va">r</span> <span class="op">=</span> <span class="fu"><a href="../reference/merge.html">split</a></span><span class="op">(</span><span class="fu"><a href="../reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="va">tif</span><span class="op">)</span><span class="op">)</span>
<span class="va">pc</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/prcomp.html">prcomp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span><span class="op">[</span>,<span class="op">-</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span> <span class="co"># based on all data</span>
<span class="va">out</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">pc</span><span class="op">)</span>
<span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/merge.html">merge</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span>, breaks <span class="op">=</span> <span class="st">"equal"</span>, join_zlim <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<p><img src="stars7_files/figure-html/unnamed-chunk-11-1.png" width="700"></p>
<p>We see, amongst others, that PC1 picks up the difference between sea (dark) and land, and PC2 and 3 structures in sea and coastal waters.</p>
<p>In the second example, we build principal components from a sample of the entire data set, because the entire dataset is rather large. We apply it, using <code>predict</code>, to pixels shown in the plot (i.e. at reduced rather than full resolution)</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">granule</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"sentinel/S2A_MSIL1C_20180220T105051_N0206_R051_T32ULE_20180221T134037.zip"</span>, 
   package <span class="op">=</span> <span class="st">"starsdata"</span><span class="op">)</span>
<span class="va">s2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"SENTINEL2_L1C:/vsizip/"</span>, <span class="va">granule</span>, 
<span class="st">"/S2A_MSIL1C_20180220T105051_N0206_R051_T32ULE_20180221T134037.SAFE/MTD_MSIL1C.xml:10m:EPSG_32632"</span><span class="op">)</span>
<span class="va">p</span> <span class="op">=</span> <span class="fu"><a href="../reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="va">s2</span>, proxy <span class="op">=</span> <span class="cn">TRUE</span>, NA_value <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/merge.html">split</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">r</span> <span class="op">=</span> <span class="fu">st_sample</span><span class="op">(</span><span class="va">p</span>, <span class="fl">1000</span><span class="op">)</span>
<span class="va">pc</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/prcomp.html">prcomp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html">na.omit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span><span class="op">)</span><span class="op">[</span>,<span class="op">-</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span> <span class="co"># based on all data</span>
<span class="va">out</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">p</span>, <span class="va">pc</span><span class="op">)</span></code></pre></div>
<p>Before plotting this, we’ll add country borders that delineate sea, obtained from the <code>mapdata</code> package:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">bb</span> <span class="op">=</span> <span class="fu">st_bbox</span><span class="op">(</span><span class="va">p</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">st_as_sfc</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="fl">4326</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">st_bbox</span><span class="op">(</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">maps</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">mapdata</span><span class="op">)</span>
<span class="va">m</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/maps/man/map.html">map</a></span><span class="op">(</span><span class="st">"worldHires"</span>, xlim <span class="op">=</span> <span class="va">bb</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">)</span><span class="op">]</span>, ylim <span class="op">=</span> <span class="va">bb</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">4</span><span class="op">)</span><span class="op">]</span>, plot<span class="op">=</span><span class="cn">F</span>,fill<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">st_as_sfc</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="fu">st_crs</span><span class="op">(</span><span class="va">r</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>We plot the results with independent color ranges, so every PC is stretched over the entire grey scale.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">plt_boundary</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">m</span>, border <span class="op">=</span> <span class="st">'orange'</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/merge.html">merge</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span>, hook <span class="op">=</span> <span class="va">plt_boundary</span>, join_zlim <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<p>This suggests that PC1 picks up the difference cloud signal (difference between clouds and non-clouds), PC2 the difference between sea and land areas, and PC4 some sensor artefacts (striping in swath direction).</p>
<p>To compute full resolution (10000 x 10000 pixels) results and write them to a file, use</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/write_stars.html">write_stars</a></span><span class="op">(</span><span class="fu"><a href="../reference/merge.html">merge</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span>, <span class="st">"out.tif"</span><span class="op">)</span></code></pre></div>
</div>
<div id="k-means-clustering" class="section level3">
<h3 class="hasAnchor">
<a href="#k-means-clustering" class="anchor"></a>K-means clustering</h3>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">clue</span><span class="op">)</span>
<span class="va">predict.kmeans</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">newdata</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/base/class.html">unclass</a></span><span class="op">(</span><span class="fu">clue</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/clue/man/cl_predict.html">cl_predict</a></span><span class="op">(</span><span class="va">object</span>, <span class="va">newdata</span><span class="op">[</span>, <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span>, <span class="va">...</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>For a small dataset:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tif</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"tif/L7_ETMs.tif"</span>, package <span class="op">=</span> <span class="st">"stars"</span><span class="op">)</span>
<span class="va">i</span> <span class="op">=</span> <span class="fu"><a href="../reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="va">tif</span>, proxy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/merge.html">split</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">nclus</span> <span class="op">=</span> <span class="fl">5</span>

<span class="va">sam</span> <span class="op">=</span> <span class="fu">st_sample</span><span class="op">(</span><span class="va">i</span>, <span class="fl">1000</span><span class="op">)</span>
<span class="va">k</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/kmeans.html">kmeans</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html">na.omit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">sam</span><span class="op">)</span><span class="op">[</span>, <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>, <span class="va">nclus</span><span class="op">)</span>
<span class="va">out</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">i</span>, <span class="va">k</span><span class="op">)</span>
<span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">out</span>, col <span class="op">=</span> <span class="fu">sf.colors</span><span class="op">(</span><span class="va">nclus</span>, categorical<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="stars7_files/figure-html/unnamed-chunk-17-1.png" width="700"></p>
<p>This seems to pick up a fair number of land cover classes: water (2), rural (3, 1), and densely populated (5, 4).</p>
<p>For the large(r) dataset:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">i</span> <span class="op">=</span> <span class="fu"><a href="../reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="va">s2</span>, proxy <span class="op">=</span> <span class="cn">TRUE</span>, NA_value <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/merge.html">split</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">sam</span> <span class="op">=</span> <span class="fu">st_sample</span><span class="op">(</span><span class="va">i</span>, <span class="fl">1000</span><span class="op">)</span>
<span class="va">k</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/kmeans.html">kmeans</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html">na.omit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">sam</span><span class="op">)</span><span class="op">[</span>, <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>, <span class="va">nclus</span><span class="op">)</span>
<span class="va">out</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">i</span>, <span class="va">k</span><span class="op">)</span>
<span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">out</span>, col <span class="op">=</span> <span class="fu">sf.colors</span><span class="op">(</span><span class="va">nclus</span>, categorical<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>, reset <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">m</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p>we see that class 5 identifies with the unclouded area, the other classes seem to mainly catch aspects of the cloud signal.</p>
</div>
</div>
<div id="supervised-learners" class="section level2">
<h2 class="hasAnchor">
<a href="#supervised-learners" class="anchor"></a>Supervised learners</h2>
<div id="random-forest-land-use-classification" class="section level3">
<h3 class="hasAnchor">
<a href="#random-forest-land-use-classification" class="anchor"></a>Random Forest land use classification</h3>
<p>The following example is purely for educational purposes; the classified “land use” is just a rough approximation from what seems to be easily visible on the image: sea, land, and areas with both but partially covered by clouds. We opted therefore for four classes: sea, land, clouds over sea, clouds over land.</p>
<p>We have polygon areas where the land use was classified, residing in a GeoPackage file. (This file was created using QGIS, using the instructions found <a href="https://www.qgistutorials.com/en/docs/digitizing_basics.html">here</a>.)</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># for all, multi-resolution, use:</span>
<span class="va">bands</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"B04"</span>, <span class="st">"B03"</span>, <span class="st">"B02"</span>, <span class="st">"B08"</span>, <span class="st">"B01"</span>, <span class="st">"B05"</span>, <span class="st">"B06"</span>, <span class="st">"B07"</span>, <span class="st">"B8A"</span>, <span class="st">"B09"</span>, <span class="st">"B10"</span>, <span class="st">"B11"</span>, <span class="st">"B12"</span><span class="op">)</span>
<span class="co"># bands = c("B04", "B03", "B02", "B08")</span>
<span class="va">s2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"/vsizip/"</span>, <span class="va">granule</span>, 
<span class="st">"/S2A_MSIL1C_20180220T105051_N0206_R051_T32ULE_20180221T134037.SAFE/GRANULE/L1C_T32ULE_A013919_20180220T105539/IMG_DATA/T32ULE_20180220T105051_"</span>, <span class="va">bands</span>, <span class="st">".jp2"</span><span class="op">)</span>
<span class="va">r</span> <span class="op">=</span> <span class="fu"><a href="../reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="va">s2</span>, proxy <span class="op">=</span> <span class="cn">TRUE</span>, NA_value <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="va">bands</span><span class="op">)</span> 
<span class="va">cl</span> <span class="op">=</span> <span class="fu">read_sf</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"gpkg/s2.gpkg"</span>, package <span class="op">=</span> <span class="st">"stars"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="fu">st_crs</span><span class="op">(</span><span class="va">r</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">r</span>, reset <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">cl</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">m</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, border <span class="op">=</span> <span class="st">'orange'</span><span class="op">)</span></code></pre></div>
<p>Next, we need points, sampled inside these polygons, for which we need to extract the satellite spectral data</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pts</span> <span class="op">=</span> <span class="fu">st_sample</span><span class="op">(</span><span class="va">cl</span>, <span class="fl">1000</span>, <span class="st">"regular"</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">st_intersection</span><span class="op">(</span><span class="va">cl</span><span class="op">)</span>
<span class="va">train</span> <span class="op">=</span> <span class="fu"><a href="../reference/st_extract.html">st_extract</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">pts</span><span class="op">)</span>
<span class="va">train</span><span class="op">$</span><span class="va">use</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">pts</span><span class="op">$</span><span class="va">use</span><span class="op">)</span> <span class="co"># no need for join, since the order did not change</span>
<span class="va">train</span></code></pre></div>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://www.stat.berkeley.edu/~breiman/RandomForests/">randomForest</a></span><span class="op">)</span>
<span class="va">train</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">train</span><span class="op">)</span>
<span class="va">train</span><span class="op">$</span><span class="va">x</span> <span class="op">=</span> <span class="cn">NULL</span> <span class="co"># remove geometry</span>
<span class="va">rf</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/randomForest/man/randomForest.html">randomForest</a></span><span class="op">(</span><span class="va">use</span> <span class="op">~</span> <span class="va">.</span>, <span class="va">train</span><span class="op">)</span> <span class="co"># ~ . : use all other attributes</span>
<span class="va">pr</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">rf</span><span class="op">)</span>
<span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">pr</span>, key.width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/graphics/layout.html">lcm</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>, reset <span class="op">=</span> <span class="cn">FALSE</span>, key.pos <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>
<span class="co"># add country outline:</span>
<span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">m</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p>This comes with the rather trivial finding that land and sea can be well predicted when there are no clouds, and the less trivial finding that they can be reasonably distinguished through patchy clouds of this kind. Note that predictions of this kind are pure pixel-based: for each prediction only the spectral bands for this pixel are considered, not for instance of any neighboring pixels.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Edzer Pebesma.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
